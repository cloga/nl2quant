# DCA 定投回测平台 - 完整使用指南

## 📋 目录

1. [功能概览](#功能概览)
2. [快速开始](#快速开始)
3. [核心功能详解](#核心功能详解)
4. [性能指标参考](#性能指标参考)
5. [策略设计框架](#策略设计框架)
6. [常见问题](#常见问题)

---

## 功能概览

### 核心模块

| 模块 | 文件 | 功能 |
|------|------|------|
| **后端引擎** | `app/dca_backtest_engine.py` | DCA/智能定投回测、数据获取、指标计算 |
| **Web应用** | `dca_web_app.py` | Streamlit交互界面 |
| **报告生成** | `app/report_generator.py` | HTML报告、JSON导出 |

### 支持的策略

1. **普通定投 (Plain DCA)**
   - 每期固定金额投资
   - 最简单直接的定投方案

2. **智能PE定投 (Smart PE)**
   - 根据PE百分位自动调整投资金额
   - 低估时加倍投资，高估时减少投资
   - 适合有估值意识的投资者

3. **智能PB定投 (Smart PB)**
   - 根据PB百分位自动调整投资金额
   - 类似PE策略但基于市净率
   - 适合价值投资思路

---

## 快速开始

### 1. 环境配置

```bash
# 安装依赖
pip install -r requirements.txt

# 配置 Tushare Token
# 编辑 .env 文件
TUSHARE_TOKEN=your_token_here
```

### 2. 启动应用

```bash
# Windows PowerShell
.\run_dca_app.ps1

# 或直接用 Streamlit
streamlit run dca_web_app.py --server.port=8501
```

### 3. 进行回测

1. 在左侧配置面板选择或自定义组合
2. 选择投资策略（普通/智能PE/智能PB）
3. 设置投资参数（金额、频率、时间范围）
4. 点击"开始回测"按钮

---

## 核心功能详解

### 📊 性能指标体系

根据 **Common Portfolio Evaluation Metrics**，平台计算以下核心指标：

#### 收益类指标
- **CAGR (年化复合增长率)**
  - 公式：$\text{CAGR} = \left(\frac{\text{期末资产}}{\text{初始投入}}\right)^{1/年数} - 1$
  - 用途：衡量长期增长能力
  - 参考：3-6% 为稳健，6-10% 为良好，>10% 为优秀

- **总收益率**
  - 公式：$\text{总收益} = \frac{\text{期末资产} - \text{累计投入}}{\text{累计投入}}$
  - 用途：回测期间的整体表现

#### 风险类指标
- **年化波动率 (Volatility)**
  - 定义：月度收益率的标准差，年化后
  - 参考：<8% 低波动，8-15% 中等，>15% 高波动
  
- **最大回撤 (Max Drawdown)**
  - 定义：历史任意时刻的最大跌幅
  - 参考：<10% 非常稳健，<20% 可接受，>30% 高风险

#### 风险调整收益指标 ⭐ 最重要
- **Sharpe 比率**
  - 公式：$\text{Sharpe} = \frac{\text{CAGR} - 0}{\text{波动率}}$
  - 含义：每单位总风险获得的超额收益
  - 参考：>1.0 良好，>1.5 优秀，>2.0 杰出

- **Sortino 比率**
  - 公式：$\text{Sortino} = \frac{\text{CAGR}}{\text{下行波动率}}$
  - 含义：仅考虑负收益波动，更贴近实际风险
  - 参考：>1.0 良好，>2.0 优秀
  - **推荐用于卖Put/定投等倾向于单向波动的策略**

- **Calmar 比率**
  - 公式：$\text{Calmar} = \frac{\text{CAGR}}{|\text{最大回撤}|}$
  - 含义：年收益与最大回撤的比值，衡量回撤修复能力
  - 参考：>2.0 稳健，>1.0 可接受，<0.5 需警惕
  - **值为1意味着需要1年完全弥补最大回撤**

#### 交易特性指标
- **月度胜率 (Win Rate)**
  - 定义：正收益月份占总月数的比例
  - 参考：>55% 稳定，>60% 良好
  - **定投策略中胜率通常较高（50-70%），不必追求极端胜率**

### 🎯 智能定投策略详解

#### 策略原理

智能PE/PB定投基于估值分位数动态调整投资金额：

1. **计算历史估值分布**
   - 获取过去N天(默认5年)的PE/PB数据
   - 计算当前估值的百分位排名

2. **确定估值档位**
   ```
   百分位 0-33%  → 低估  → 买入倍数 ↑↑↑
   百分位 33-67% → 正常  → 买入倍数 ×1
   百分位 67-100%→ 高估  → 买入倍数 ↓↓↓
   ```

3. **动态调整投资金额**
   ```
   实际投资额 = 基础金额 × 倍数
   ```

#### 参数设置

| 参数 | 含义 | 默认值 | 建议范围 |
|------|------|--------|---------|
| 低估倍数 | 极度便宜时买几倍 | 2.0 | 1.5-3.0 |
| 高估倍数 | 极度昂贵时买几倍 | 0.5 | 0.0-1.0 |
| 回看周期 | 计算分位数的历史天数 | 1260(5年) | 252-2520(1-10年) |

#### 场景示例

**场景1：沪深300在5年低估期**
- PE分位：20%（底部20%）
- 规则：低估倍数=2.0
- 结果：每月投资 10,000 × 2.0 = 20,000 元

**场景2：沪深300在历史高位**
- PE分位：90%（顶部10%）
- 规则：高估倍数=0.5
- 结果：每月投资 10,000 × 0.5 = 5,000 元（可选0停止投资）

### 💰 成本与摩擦模拟

平台支持模拟实盘成本：

| 参数 | 说明 | 典型值 |
|------|------|--------|
| 佣金费率 | 万分之几 | 1-5万分之 |
| 最低佣金 | 单笔最低费用 | 5元 |
| 滑点 | 成交价偏离程度 | 0.1% |

**费用计算**
```
实际成本 = max(投资额 × 佣金率, 最低佣金)
实际成交价 = 收盘价 × (1 + 滑点)
实际买入份数 = (投资额 - 费用) / 成交价
```

---

## 性能指标参考

### 🎓 指标快速判断表

| 指标 | <30分位 | 30-70分位 | >70分位 | 解读 |
|------|---------|----------|---------|------|
| **CAGR** | <3% | 3-8% | >8% | 年增长能力 |
| **Sharpe** | <0.5 | 0.5-1.5 | >1.5 | 风险效率 |
| **Sortino** | <0.5 | 0.5-2.0 | >2.0 | 下行风险效率 |
| **Calmar** | <0.5 | 0.5-2.0 | >2.0 | 回撤恢复力 |
| **波动率** | <8% | 8-15% | >15% | 风险水平 |
| **最大回撤** | >-30% | -20% ~ -10% | <-10% | 抗风险能力 |
| **胜率** | <50% | 50-65% | >65% | 盈利稳定性 |

### 📈 典型组合参考值

#### 全天候组合（40债60股）
```
推荐指标目标:
- CAGR: 5-7%
- Sharpe: 0.8-1.2
- 波动率: 7-10%
- 最大回撤: -10% ~ -15%
```

#### 激进增长（100%股票）
```
推荐指标目标:
- CAGR: 7-12%
- Sharpe: 0.6-1.0
- 波动率: 12-18%
- 最大回撤: -20% ~ -35%
```

#### 保守稳健（80债20股）
```
推荐指标目标:
- CAGR: 3-5%
- Sharpe: 0.9-1.3
- 波动率: 4-7%
- 最大回撤: -5% ~ -10%
```

---

## 策略设计框架

基于 `dca_strategy_design.md` 的完整框架，包括 **钱、时、货、买、退、费、比** 七大维度：

### 一、钱：资金管理
- **初始本金**: 账户启动资金
- **定期投入**: 每月/季/年投资金额
- **现金利息**: 闲置资金享受的收益率（可选）

### 二、时：时间维度
- **回测周期**: 选择有代表性的时间段（建议≥3年）
- **投资频率**: M(月)、Q(季)、Y(年)
- **投资日期**: 固定日期或浮动日期

### 三、货：投资标的
- **单资产**: 单个ETF（如510300）
- **组合**: 多个ETF加权组合
- **数据来源**: Tushare fund_daily API

### 四、买：进场策略
- **普通定投**: 固定金额
- **智能PE**: PE分位数驱动
- **智能PB**: PB分位数驱动
- **价值平均**: 目标增长率驱动（计划中）

### 五、退：止盈与风控
- **长期持有**: 不设止盈（推荐）
- **目标止盈**: 达到目标收益率后清仓
- **移动止盈**: 从高点回撤超过阈值后清仓

### 六、费：成本磨损
- **佣金**: 按比例 + 最低金额
- **滑点**: 执行价偏离
- **税费**: 不含（可选模拟）

### 七、比：基准对标
- **一次性买入**: 初始全仓投入
- **普通定投**: 固定定投对标
- **目标基准**: 相关指数（如沪深300）

---

## 常见问题

### Q1: 为什么推荐Sortino而不是Sharpe？
**A:** 
- Sharpe考虑全部波动（上涨和下跌）
- Sortino仅考虑负向波动（亏损）
- 对于定投这类倾向单向收益的策略，Sortino更贴近真实风险
- 在同等CAGR下，Sortino更高的策略通常上涨波动更大，下跌更稳定

### Q2: 智能定投真的能跑赢普通定投吗？
**A:** 
- 取决于标的和时间段
- 在反复震荡市中，智能定投优势显著（可节省成本）
- 在单向牛市中，普通定投效果更好（保持满仓）
- 建议两种都回测对比

### Q3: 月度胜率60%意味着什么？
**A:**
- 12个月中约7.2个月上涨，4.8个月下跌
- 这是正常的市场波动
- 不需要追求过高胜率（80%+通常不现实或含有幸存者偏差）

### Q4: 回撤-20%是高是低？
**A:**
- 对于60/40组合：属于中等，可接受
- 对于100%股票：属于低，说明市场温和
- 对于保守组合：偏高，需要调整

### Q5: Calmar比率为0.8意味着什么？
**A:**
- 假设年收益8%，最大回撤-10%
- Calmar = 8% / 10% = 0.8
- 需要 1/0.8 = 1.25年 完全修复最大回撤
- 参考标准：>2.0优秀，>1.0可接受，<0.5较差

### Q6: 如何理解PE分位数？
**A:**
```
PE分位 = 历史PE ≤ 当前PE 的天数比例

例如:
PE分位 = 30% → 当前PE在历史低估期
PE分位 = 70% → 当前PE在历史高估期

应用：
分位 0-33% → 买入 × 低估倍数 (如2.0)
分位 33-67% → 买入 × 1.0 (正常)
分位 67-100% → 买入 × 高估倍数 (如0.5)
```

### Q7: 智能定投的回看周期应该选多长？
**A:**
- **1年 (252天)**: 反映近期波动，容易高频调整
- **5年 (1260天)**: 平衡性好，包含完整牛熊周期
- **10年 (2520天)**: 长周期参考，但数据获取困难
- **建议**: 5年最平衡

### Q8: 为什么我的回测结果与行情软件不一致？
**A:**
- 数据源差异（Tushare vs 其他）
- 不含分红再投资（可选配置）
- 时间范围不同
- 费用假设不同
- **建议**: 用同一数据源对比

### Q9: 单笔投资额100元，最低佣金5元，这样可行吗？
**A:**
- 佣金比率 = 5/100 = 5% （太高）
- **不建议单笔投资<1000元**
- 若做高频定投，应与券商协商费率

### Q10: 能否模拟税费？
**A:**
- 当前版本不含税费模拟
- 可在"成本与摩擦参数"中提高"滑点"作为变相成本
- 计划版本中加入税费计算

---

## 📚 进阶资源

### 文档
- `README_DCA.md` - 平台总体说明
- `QUICKSTART_DCA.md` - 5分钟快速上手
- `design/Common Portfolio Evaluation Metrics.md` - 指标详解
- `design/dca_strategy_design.md` - 策略设计框架

### 相关API
- Tushare: https://www.tushare.pro
- Streamlit: https://streamlit.io
- Plotly: https://plotly.com

---

**最后更新**: 2025-12-09  
**版本**: 1.0
