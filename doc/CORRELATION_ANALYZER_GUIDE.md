# 标的相关性分析工具 (Correlation Analyzer)

## 概述

这是一个基于**6维度分析框架**的综合相关性分析工具，支持**股票、基金、指数**等多种资产类型。

### 核心特性

✓ **自动资产识别** - 支持自动识别股票、基金、指数  
✓ **6维度分析框架** - 从静态到动态、从线性到非线性的深度分析  
✓ **无需指定时间范围** - 默认使用全部可用数据（自动对齐）  
✓ **综合报告生成** - 自动生成Markdown格式的分析报告  
✓ **多种分析模式** - 支持全面分析或单维度深入分析  

## 6维度分析框架

### 维度1: 线性与方向分析 (Linearity & Direction)

分析两个标的的基础相关关系：

| 指标 | 说明 | 应用场景 |
|------|------|--------|
| **Pearson相关系数** | 衡量线性相关程度 | 快速判断两者是否同涨同跌 |
| **Spearman秩相关系数** | 衡量单调相关性，对极端值不敏感 | 当数据存在极值时更准确 |
| **Kendall Tau** | 衡量排序一致性 | 样本量小或存在异常值时用 |
| **Beta系数** | 衡量相对于基准的敏感度 | 评估标的B对标的A的波动放大 |

**报告示例:**
```
Pearson相关系数: 0.2402 (极弱或无相关)
Spearman秩相关系数: 0.4976 (中等相关)
Beta系数: 0.8195 (标的B比标的A波动幅度小20%)
```

### 维度2: 协整与长期均衡 (Cointegration & Equilibrium)

识别是否存在**长期均值回归机会**（配对交易核心）：

| 指标 | 说明 | 应用场景 |
|------|------|--------|
| **Engle-Granger检验** | 检验两个序列是否协整 | 判断是否存在套利机会 |
| **ADF检验（价差序列）** | 检验价差是否平稳 | 确认均值回归特性 |
| **Z-Score分析** | 衡量价差离均值的距离 | 确定套利入场点 |

**报告示例:**
```
Engle-Granger P值: 0.921 (不存在协整关系)
价差Z-Score: -1.53 (价差低估，可考虑做多低估标的)
极端事件频率: 11.09% (频繁出现套利机会)
```

### 维度3: 时间领先与因果 (Lead-Lag & Causality)

识别"谁先动，谁后动"的关系：

| 指标 | 说明 | 应用场景 |
|------|------|--------|
| **Granger因果检验** | 检验时间序列的预测性领先关系 | 判断A是否能预测B的未来走势 |
| **互相关分析** | 找到最大相关的滞后期 | 确定领先时间（天数） |

**报告示例:**
```
互相关分析最大值: lag=0日 (当日同步，无领先关系)
峰值相关系数: 0.2402 (关系较弱)
```

### 维度4: 动态时变性 (Dynamic & Time-Varying)

捕捉相关性的时间变化：

| 指标 | 说明 | 应用场景 |
|------|------|--------|
| **滚动相关系数** | 固定窗口计算的时间序列相关性 | 发现"解耦事件"（相关性突然失效） |
| **相关性波动率** | 相关性的标准差 | 衡量关系的稳定性 |

**报告示例:**
```
滚动相关系数（30天窗口）:
  - 当前: 0.7384
  - 平均: 0.7694
  - 波动率: 0.1585 (中等波动，关系较稳定)
  - 发现11次显著解耦事件
```

### 维度5: 极端风险与尾部依赖 (Tail Dependence)

分析**极端行情**下的联动：

| 指标 | 说明 | 应用场景 |
|------|------|--------|
| **左尾依赖** | 一个暴跌时另一个也暴跌的概率 | 评估投资组合在危机中的风险 |
| **右尾依赖** | 一个暴涨时另一个也暴涨的概率 | 评估收益共享程度 |

**报告示例:**
```
左尾依赖 (暴跌): 58.6% (当A暴跌时，B也暴跌的概率58.6%)
右尾依赖 (暴涨): 59.0% (当A暴涨时，B也暴涨的概率59.0%)
风险评估: 中等 (尾部依赖适中，组合对冲有效性中等)
```

### 维度6: 基本面逻辑 (Fundamental Logic)

通过**人工判断**基本面关联：

常见关联类型：
- **产业链关系** (原料→产品): 大豆↔豆粕、原油↔航空股
- **替代/竞争** (竞争品): 可口可乐↔百事可乐
- **宏观驱动** (同一因子): 银行股↔利率、科技股↔汇率

## 使用方法

### 基础用法

```bash
# 综合分析（推荐）
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH

# 保存报告到文件
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --output report.md
```

### 支持的资产类型

**自动识别（推荐）:**
```bash
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH
```

**显式指定:**
```bash
# 股票 vs 基金
python scripts/correlation_cli.py \
  --code1 600036.SH --type1 stock \
  --code2 510050.SH --type2 fund

# 股票 vs 指数
python scripts/correlation_cli.py \
  --code1 000001.SZ --type1 stock \
  --code2 399300.SZ --type2 index

# 两只基金
python scripts/correlation_cli.py \
  --code1 510050.SH --type1 fund \
  --code2 510180.SH --type2 fund
```

### 单维度分析

```bash
# 只做线性相关分析
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --dimension linear

# 只做协整检验
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --dimension cointegration

# 只做Granger因果检验
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --dimension granger

# 只做滚动相关分析
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --dimension rolling --window 20

# 只做尾部依赖分析
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --dimension tail
```

## 实际案例分析

### 案例1: 招商银行(600036) vs 兴业银行(601166)

**目标:** 评估两只银行股是否适合配对交易

**命令:**
```bash
python scripts/correlation_cli.py --code1 600036.SH --code2 601166.SH --output bank_analysis.md
```

**关键发现:**

| 维度 | 结果 | 解读 |
|------|------|------|
| Pearson相关系数 | 0.2402 | 极弱相关，不是同向股票 |
| Spearman秩相关 | 0.4976 | 秩相关性中等，说明涨跌频率有关系 |
| Beta系数 | 0.82 | 兴业银行波动比招商银行小20% |
| 协整检验 | P=0.92 | **不存在协整关系**，无法做均值回归套利 |
| 价差Z-Score | -1.53 | 价差略低于均值，但无极端信号 |
| 滚动相关系数 | 0.77±0.16 | 相关性波动中等，存在11次解耦事件 |
| 尾部依赖 | 58.6% | 联动性中等，组合对冲有限效果 |

**综合建议:**
- ❌ **不适合配对交易** - 虽然都是银行股，但缺乏协整关系，长期价差无均值回归特性
- ✓ **可用于行业轮动** - 秩相关性强，涨跌节奏同步，可用于选择相对强弱的标的
- ⚠️ **组合风险中等** - 极端行情下联动性不算很高，可作为分散投资的一部分

---

### 案例2: 黄金ETF(518880) vs 黄金股ETF(159562)

**目标:** 评估商品现货vs产业链的关系

**命令:**
```bash
python scripts/correlation_cli.py --code1 518880.SH --code2 159562.SZ --output gold_analysis.md
```

**期望结果:**
- 应该存在**较强正相关** (相同大宗商品驱动)
- 可能存在**协整关系** (长期均衡)
- 现货可能**领先产业**1-2天

---

## 输出报告说明

### 报告结构

生成的Markdown报告包含：

1. **维度1-5的详细分析** - 数据表格 + 解释
2. **综合建议** - 基于6维分析的决策建议
   - 相关性稳定性评估
   - 套利机会评估
   - 风险对冲效果评估

### 报告示例

```markdown
======================================================================
[维度1] 线性与方向分析
======================================================================

Pearson相关系数: 0.2402 (极弱或无相关)
  - P值: 0.000000

Beta系数 (601166.SH相对600036.SH):
  - β = 0.8195
  - 解释: 601166.SH相对600036.SH的敏感度: 0.820倍

======================================================================
综合建议
======================================================================

1. 相关性稳定性: 中等
   → 滚动相关系数波动: 0.1585

2. 套利机会: 无
   → 协整关系: False
   → 极端事件频率: 11.09%

3. 风险对冲: 有限
   → 正常时相关性: 0.2402
   → 极端时相关性: 58.6%
```

## 应用场景

### 1. 配对交易 (Pairs Trading)

**关键指标:**
- Engle-Granger P值 < 0.05 ✓
- 价差Z-Score |z| > 2 ✓
- 极端事件频率 > 5% ✓

**案例:** 如果两只股票协整，价差频繁超过2σ，则可以：
- 当价差>+2σ: 做多低估标的，做空高估标的
- 当价差<-2σ: 反向操作
- 当价差→均值: 平仓获利

### 2. 行业轮动

**关键指标:**
- Spearman秩相关系数 > 0.7
- 相关性稳定性高 (波动率 < 0.2)

**案例:** 银行板块内选择相对强弱标的进行轮动

### 3. 投资组合风险管理

**关键指标:**
- 左尾依赖 < 0.5 ✓
- 下跌时解耦性强 ✓

**案例:** 用于评估两个资产的对冲效果，在风险资产+安全资产的配置中

### 4. 跨市场套利 (A股 vs H股)

**关键指标:**
- 协整关系强 ✓
- 领先关系明确 ✓
- 溢价率异常 ✓

**案例:** 同一公司A+H股，利用临时溢价率异常获利

## 技术依赖

```
tushare >= 1.2.0
pandas >= 1.3.0
numpy >= 1.21.0
scipy >= 1.7.0
statsmodels >= 0.13.0
```

## 常见问题 (FAQ)

**Q1: 为什么Granger检验失败？**
A: 数据长度不足或数据质量问题。该工具自动处理，返回"无显著因果关系"。

**Q2: 协整关系不存在，还能做配对交易吗？**
A: 不建议。协整关系是配对交易的理论基础。如果不存在，长期价差无回归保障。

**Q3: 相关系数高 (>0.9) 就能做配对交易吗？**
A: 不一定。需要同时满足：相关 + 协整 + 频繁极端事件。相关性只是必要条件，不是充分条件。

**Q4: 滚动相关系数波动大意味着什么？**
A: 意味着两者的关系在变化。可能是：
- 市场环境变化（牛熊转换）
- 产业关系变化
- 政策冲击
- 黑天鹅事件

**Q5: 如何解释"解耦事件"？**
A: 当滚动相关系数突然下降 > 0.2 时，说明两者历史关系突然失效。需要调查原因并重新评估策略。

## 后续改进方向

- [ ] 支持多维度对比（多组标的）
- [ ] 自动生成可视化图表 (matplotlib/plotly)
- [ ] 支持不同时间窗口的动态分析
- [ ] 集成机器学习预测（LSTM预测相关性变化）
- [ ] Web界面支持
- [ ] 批量分析支持

## 参考文献

1. **协整检验**: Engle, R. F., & Granger, C. W. (1987). "Co-integration and error correction: Representation, estimation and testing."
2. **Granger因果**: Granger, C. W. (1969). "Investigating causal relations by econometric models."
3. **尾部依赖**: Joe, H. (1997). "Multivariate models and dependence concepts."

---

**最后更新:** 2025-12-11
**维护者:** nl2quant 项目
