># DCA 定投回测 - 多页面应用指南

## 📌 项目结构

本项目已将 DCA 定投回测功能集成到 **Streamlit 多页面应用** 中。

```
nl2quant/
├── main.py                          # 主应用入口
├── app/
│   ├── config.py
│   ├── dca_backtest_engine.py       # DCA 回测引擎
│   ├── report_generator.py          # 报告生成模块
│   ├── pages/                       # 多页面应用目录
│   │   ├── 1_DCA_Backtest.py       # 📊 页面1: 单个策略回测
│   │   └── 2_Strategy_Comparison.py # 🎯 页面2: 多策略对比
│   └── ...其他模块
├── DCA_COMPLETE_GUIDE.md            # 完整功能文档
├── START_HERE.md                    # 快速开始指南
└── ...其他文件
```

## 🚀 如何使用

### 启动应用

```bash
streamlit run main.py
```

应用启动后会在浏览器中打开，默认进入主对话界面。

### 访问 DCA 功能

在左侧导航栏中选择：

#### 📊 **页面1: DCA 定投回测** (`1_DCA_Backtest.py`)

用于对单个 ETF 进行回测分析。

**功能：**
- 选择预设投资组合或输入自定义 ETF 代码
- 配置投资参数（金额、频率、时间范围）
- 选择三种策略：
  - 普通定投（固定金额）
  - 智能 PE 定投（根据估值动态调整）
  - 智能 PB 定投（根据市净率动态调整）
- 配置成本参数（佣金、最低费用、滑点）
- 查看详细回测结果：
  - 7 个核心指标（CAGR、Sharpe、Sortino 等）
  - 净值曲线图表
  - 期末持仓
  - 交易记录
  - 导出 CSV 数据

**使用流程：**
1. 在左侧边栏配置参数
2. 点击「开始回测」按钮
3. 等待结果加载
4. 查看可视化图表和数据表格
5. 导出数据进行进一步分析

#### 🎯 **页面2: DCA 策略对比** (`2_Strategy_Comparison.py`)

用于对比三个不同的投资策略在同一时间段的性能。

**功能：**
- 同时运行三个策略的回测：普通定投、智能 PE、智能 PB
- 生成性能对比表格
- 绘制净值曲线对比图
- 柱状图对比：CAGR、Sharpe、最大回撤、波动率
- 查看每个策略的详细统计信息

**使用流程：**
1. 输入 ETF 代码
2. 选择分析时间范围
3. 配置投资参数和智能定投参数
4. 点击「运行对比分析」
5. 查看三个策略的性能对比结果

## 📊 核心功能详解

### 三个投资策略

| 策略名称 | 说明 | 适用场景 |
|---------|------|--------|
| **普通定投** (plain) | 每期固定金额投资 | 稳定资金流，无法择时 |
| **智能PE定投** (smart_pe) | 根据PE百分位调整金额：低估时多买，高估时少买 | 相信均值回归，关注估值 |
| **智能PB定投** (smart_pb) | 根据PB百分位调整金额 | 关注资产质量，偏好价值型 |

### 智能定投参数

- **低估倍数**: 当估值极度低估时的投资倍数（默认 2.0x）
- **高估倍数**: 当估值极度高估时的投资倍数（默认 0.5x，0 表示暂停投资）
- **回看周期**: 计算估值分位数的历史天数（默认 5 年 = 1260 天）

### 性能指标（7 类）

**返回类指标：**
- CAGR: 年化复合收益率
- 总收益率: 期间总收益百分比

**风险类指标：**
- 年化波动率: 收益率的标准差
- 最大回撤: 历史最大亏损幅度

**风险调整类指标：**
- Sharpe 比率: 单位总风险的超额收益
- Sortino 比率: 单位下行风险的超额收益
- Calmar 比率: 年收益 / 最大回撤

**交易特征：**
- 月度胜率: 正收益月数占比

## 💡 使用建议

### 选择策略的步骤

1. **使用页面2进行策略对比**
   - 在同一时间段对比三个策略的表现
   - 查看 Sharpe 比率而非单纯总收益
   - 考虑最大回撤（风险）

2. **关注关键指标**
   - CAGR ≥ 8% 为较好水平
   - Sharpe ≥ 1.0 为良好风险调整收益
   - 最大回撤 ≤ 30% 为可接受范围

3. **在页面1进行详细分析**
   - 选择表现较好的策略
   - 调整参数（低估/高估倍数、回看周期）
   - 查看交易记录理解策略逻辑

### 参数调整建议

| 参数 | 含义 | 调整方向 |
|------|------|--------|
| 低估倍数 | 便宜时买多少倍 | ↑ 更激进，↓ 更保守 |
| 高估倍数 | 贵时买多少倍 | ↑ 更坚定，↓ 更灵活 |
| 回看周期 | 估值历史长度 | ↑ 更稳定，↓ 更敏感 |
| 投资金额 | 每期投资 | 根据资金量调整 |

### 数据导出和进一步分析

从页面1可以导出三种数据：
- **净值曲线**: 包含每日的资产总值
- **持仓信息**: 最终持仓的代码、数量、市值等
- **交易记录**: 所有交易的详细信息

导出后可在 Excel 或 Python 中进一步分析。

## 🔧 技术架构

### 文件说明

**`app/pages/1_DCA_Backtest.py`** (600+ 行)
- 单策略回测页面
- 调用 `DCABacktestEngine.run_smart_dca_backtest()`
- 生成交互式可视化图表
- 支持数据导出

**`app/pages/2_Strategy_Comparison.py`** (500+ 行)
- 多策略对比页面
- 并行执行三个策略的回测
- 生成对比表格和柱状图
- 支持详细统计展开查看

**`app/dca_backtest_engine.py`** (600+ 行)
- 核心回测引擎
- 支持 4 种策略：plain, smart_pe, smart_pb, value_averaging
- 集成 Tushare 数据源获取价格和估值数据
- 计算 7 个指标类（9 个总指标）
- 处理成本和摩擦

### 依赖包

```
streamlit>=1.0
pandas>=1.0
plotly>=5.0
numpy>=1.20
tushare>=1.2.60
langchain>=0.0.200
dotenv>=0.20
```

## 🎯 常见问题

### Q1: 为什么显示 "ETF代码不存在"？
A: 请确保 ETF 代码正确。常见代码：
- 510300 (沪深300)
- 159915 (创业板)
- 159601 (港股通)
- 510880 (红利)

### Q2: 智能定投需要什么条件？
A: 需要获取估值数据（PE-TTM 和 PB），目前从 Tushare 获取。
如果数据不可用，请检查：
- Tushare 连接是否正常
- ETF 对应的行业是否有估值数据

### Q3: 如何调整风险等级？
A: 通过调整**高估倍数**：
- 高估倍数 = 0: 激进（贵时不买）
- 高估倍数 = 0.5: 平衡（贵时少买）
- 高估倍数 = 1.0: 保守（全程买）

### Q4: 回测性能与实际不符的原因？
A: 历史回测不能保证未来表现，可能原因：
- 市场结构发生变化
- 估值范围偏离历史
- 成本参数与实际不符

## 📚 更多资源

- **DCA_COMPLETE_GUIDE.md**: 完整功能文档和 10 个常见问题答案
- **START_HERE.md**: 快速开始指南和项目概览
- **QUICKSTART_DCA.md**: 5 分钟快速上手

## 📝 许可证

MIT License

## 🤝 反馈与改进

如有问题或改进建议，请联系开发团队。
