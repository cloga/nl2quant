# PEæ•°æ®ç¼“å­˜ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

PEæ•°æ®ç¼“å­˜ç³»ç»Ÿæä¾›äº†é«˜æ•ˆçš„è‚¡ç¥¨å¸‚ç›ˆç‡æ•°æ®ç®¡ç†æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
- æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤è®¡ç®—
- æ‰¹é‡è·å–è¡Œæƒ…æ•°æ®ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- Webç•Œé¢ç®¡ç†ï¼Œå®æ—¶æŸ¥çœ‹æ›´æ–°è¿›åº¦
- å¢é‡æ›´æ–°æ”¯æŒ

## æ ¸å¿ƒç»„ä»¶

### 1. ç¼“å­˜ç®¡ç†æ¨¡å— (`app/data/pe_cache.py`)

**ä¸»è¦ç±»å’Œå‡½æ•°ï¼š**

- `PECache`: ç¼“å­˜ç®¡ç†å™¨ç±»
  - `get_metadata()`: è·å–ç¼“å­˜å…ƒæ•°æ®ï¼ˆæ›´æ–°æ—¥æœŸã€è®°å½•æ•°ç­‰ï¼‰
  - `load_cache()`: åŠ è½½ç¼“å­˜æ•°æ®
  - `save_cache()`: ä¿å­˜ç¼“å­˜æ•°æ®
  - `is_cache_fresh()`: æ£€æŸ¥ç¼“å­˜æ˜¯å¦æ–°é²œ

- `batch_compute_and_cache()`: æ‰¹é‡è®¡ç®—å¹¶ç¼“å­˜PEæ•°æ®
  - æ”¯æŒå¢é‡æ›´æ–°ï¼ˆè·³è¿‡å·²ç¼“å­˜çš„è‚¡ç¥¨ï¼‰
  - æ”¯æŒå¼ºåˆ¶å…¨é‡æ›´æ–°
  - æ‰¹é‡è·å–è¡Œæƒ…æ•°æ®ä¼˜åŒ–
  - å®æ—¶è¿›åº¦å›è°ƒ

### 2. Streamlitç®¡ç†é¡µé¢ (`pages/7_PE_Cache_Manager.py`)

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºç¼“å­˜çŠ¶æ€ï¼ˆè®°å½•æ•°ã€æ›´æ–°æ—¶é—´ã€æ–°é²œåº¦ï¼‰
- è§¦å‘å¼‚æ­¥æ›´æ–°ä»»åŠ¡
- å®æ—¶æ˜¾ç¤ºæ›´æ–°è¿›åº¦
- å¯¼å‡ºç¼“å­˜æ•°æ®åˆ°CSV

**ä½¿ç”¨æ­¥éª¤ï¼š**
1. å¯åŠ¨ Streamlit åº”ç”¨ï¼š`streamlit run main.py`
2. å¯¼èˆªåˆ° "PEæ•°æ®ç¼“å­˜ç®¡ç†" é¡µé¢
3. é€‰æ‹©æ›´æ–°é€‰é¡¹ï¼š
   - å‹¾é€‰"å¼ºåˆ¶å…¨é‡æ›´æ–°"ï¼šé‡æ–°è®¡ç®—æ‰€æœ‰è‚¡ç¥¨
   - "é™åˆ¶è‚¡ç¥¨æ•°é‡"ï¼šç”¨äºå°è§„æ¨¡æµ‹è¯•
4. ç‚¹å‡»"ğŸš€ å¼€å§‹æ›´æ–°"æŒ‰é’®
5. æŸ¥çœ‹å®æ—¶è¿›åº¦
6. å®Œæˆåå¯ç‚¹å‡»"ğŸ’¾ å¯¼å‡ºåˆ°CSV"

### 3. å‘½ä»¤è¡Œè„šæœ¬

#### ä¼˜åŒ–ç‰ˆè„šæœ¬ (`scripts/batch_compute_pe_v2.py`)

**ä½¿ç”¨æ–¹æ³•ï¼š**

```powershell
# ä»ç¼“å­˜å¿«é€Ÿå¯¼å‡ºï¼ˆç§’çº§å®Œæˆï¼‰
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --from-cache

# å¢é‡æ›´æ–°ï¼ˆè·³è¿‡å·²ç¼“å­˜çš„è‚¡ç¥¨ï¼‰
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py

# å¼ºåˆ¶å…¨é‡æ›´æ–°
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --force-update

# æµ‹è¯•æ¨¡å¼ï¼ˆä»…å¤„ç†å‰50åªè‚¡ç¥¨ï¼‰
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --limit 50

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --from-cache --outfile data/my_pe_data.csv
```

## æ•°æ®å­˜å‚¨

**ç¼“å­˜æ–‡ä»¶ä½ç½®ï¼š**
- `data/cache/pe_cache.json`: ä¸»ç¼“å­˜æ•°æ®
- `data/cache/pe_cache_metadata.json`: å…ƒæ•°æ®ï¼ˆæ›´æ–°æ—¶é—´ç­‰ï¼‰

**CSVå¯¼å‡ºä½ç½®ï¼š**
- `data/pe_ratios_YYYYMMDD.csv`: æ—¥æœŸå‘½åçš„å¯¼å‡ºæ–‡ä»¶

## æ€§èƒ½ä¼˜åŒ–è¯´æ˜

### 1. æ‰¹é‡è·å–è¡Œæƒ…æ•°æ®

ä¼ ç»Ÿæ–¹å¼æ¯åªè‚¡ç¥¨è°ƒç”¨ä¸€æ¬¡ `daily_basic`ï¼Œ5000åªè‚¡ç¥¨ = 5000æ¬¡è¯·æ±‚ã€‚

ä¼˜åŒ–åä¸€æ¬¡æ€§è·å–æ‰€æœ‰è‚¡ç¥¨çš„è¡Œæƒ…æ•°æ®ï¼ŒåŠ è½½åˆ°å†…å­˜å­—å…¸ä¸­ï¼š

```python
df_daily = pro.daily_basic(trade_date='')  # ä¸€æ¬¡è·å–å…¨éƒ¨
daily_basic_dict = {row['ts_code']: row for _, row in df_daily.iterrows()}
```

**ä¼˜åŠ¿ï¼š**
- ç½‘ç»œè¯·æ±‚ä» 5000 æ¬¡å‡å°‘åˆ° 1 æ¬¡
- æ•°æ®åœ¨å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾
- å—é™äº Tushare é™æµå½±å“å°

### 2. æœ¬åœ°ç¼“å­˜æœºåˆ¶

**å¢é‡æ›´æ–°é€»è¾‘ï¼š**
```python
if not force_update and ts_code in cache_data:
    skip_count += 1
    continue  # è·³è¿‡å·²ç¼“å­˜çš„è‚¡ç¥¨
```

**ä¼˜åŠ¿ï¼š**
- å·²è®¡ç®—çš„è‚¡ç¥¨æ— éœ€é‡å¤è®¡ç®—
- ç¬¬ä¸€æ¬¡å…¨é‡æ›´æ–°åï¼Œåç»­åªè®¡ç®—æ–°å¢è‚¡ç¥¨
- æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆå¼‚å¸¸é€€å‡ºåå¯ç»§ç»­ï¼‰

### 3. ç¼“å­˜å¿«é€Ÿå¯¼å‡º

ä½¿ç”¨ `--from-cache` å‚æ•°å¯ç›´æ¥ä»ç¼“å­˜å¯¼å‡ºï¼Œæ— éœ€é‡æ–°è®¡ç®—ï¼š

```python
python scripts/batch_compute_pe_v2.py --from-cache
```

**é€Ÿåº¦å¯¹æ¯”ï¼š**
- ä¼ ç»Ÿè®¡ç®—ï¼š1-2å°æ—¶ï¼ˆ5000åªè‚¡ç¥¨ï¼‰
- ç¼“å­˜å¯¼å‡ºï¼š5-10ç§’

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šé¦–æ¬¡ä½¿ç”¨

```powershell
# æ–¹å¼Aï¼šä½¿ç”¨Webç•Œé¢ï¼ˆæ¨èï¼‰
.venv\Scripts\streamlit.exe run main.py
# æ‰“å¼€"PEæ•°æ®ç¼“å­˜ç®¡ç†"é¡µé¢ -> ç‚¹å‡»"å¼€å§‹æ›´æ–°"

# æ–¹å¼Bï¼šä½¿ç”¨å‘½ä»¤è¡Œ
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --force-update
```

### åœºæ™¯2ï¼šæ¯æ—¥æ›´æ–°

```powershell
# å¢é‡æ›´æ–°ï¼ˆè‡ªåŠ¨è·³è¿‡å·²ç¼“å­˜ï¼‰
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py

# æˆ–ä½¿ç”¨Webç•Œé¢ï¼ˆå–æ¶ˆå‹¾é€‰"å¼ºåˆ¶å…¨é‡æ›´æ–°"ï¼‰
```

### åœºæ™¯3ï¼šå¿«é€Ÿåˆ†æ

```powershell
# ä»ç¼“å­˜å¯¼å‡ºæœ€æ–°æ•°æ®
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --from-cache

# æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
.venv\Scripts\streamlit.exe run main.py
# æ‰“å¼€"PEæ•°æ®ç¼“å­˜ç®¡ç†"é¡µé¢æŸ¥çœ‹æ›´æ–°æ—¶é—´å’Œè®°å½•æ•°
```

### åœºæ™¯4ï¼šæµ‹è¯•å’Œè°ƒè¯•

```powershell
# ä»…å¤„ç†å‰50åªè‚¡ç¥¨
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --limit 50

# å¼ºåˆ¶æ›´æ–°å‰50åª
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --limit 50 --force-update
```

## æ³¨æ„äº‹é¡¹

1. **Tushareé™æµï¼š** å³ä½¿ä¼˜åŒ–åï¼Œå…¨é‡æ›´æ–°ä»éœ€éµå®ˆTushareæ¥å£é™æµï¼ˆ120æ¬¡/åˆ†é’Ÿï¼‰ï¼Œçº¦éœ€1-2å°æ—¶

2. **ç¼“å­˜æœ‰æ•ˆæœŸï¼š** å»ºè®®æ¯æ—¥æ›´æ–°ä¸€æ¬¡ï¼Œç¼“å­˜ç³»ç»Ÿä¼šè‡ªåŠ¨æ ‡è®°è¶…è¿‡1å¤©çš„æ•°æ®ä¸º"éœ€è¦æ›´æ–°"

3. **ç£ç›˜ç©ºé—´ï¼š** 5000åªè‚¡ç¥¨çš„ç¼“å­˜æ–‡ä»¶çº¦10-20MBï¼Œéœ€ç¡®ä¿è¶³å¤Ÿç£ç›˜ç©ºé—´

4. **å¹¶å‘æ›´æ–°ï¼š** Webç•Œé¢ä½¿ç”¨åå°çº¿ç¨‹ï¼Œä¸é˜»å¡é¡µé¢æ“ä½œï¼Œä½†ä¸æ”¯æŒåŒæ—¶å¤šä¸ªæ›´æ–°ä»»åŠ¡

5. **é”™è¯¯å¤„ç†ï¼š** è®¡ç®—å¤±è´¥çš„è‚¡ç¥¨ä¼šè¢«è®°å½•åˆ° `.errors.txt` æ–‡ä»¶ï¼Œä¸å½±å“å…¶ä»–è‚¡ç¥¨

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç¼“å­˜ä¸ºç©º

```powershell
# æ£€æŸ¥ç¼“å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨
dir data\cache\

# å¦‚æœä¸å­˜åœ¨ï¼Œè¿è¡Œé¦–æ¬¡æ›´æ–°
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --force-update
```

### é—®é¢˜2ï¼šæ›´æ–°é€Ÿåº¦æ…¢

- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤Tushareè´¦æˆ·æƒé™ï¼ˆç§¯åˆ†æ˜¯å¦è¶³å¤Ÿï¼‰
- æŸ¥çœ‹æ˜¯å¦è§¦å‘é™æµï¼ˆç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•ï¼‰

### é—®é¢˜3ï¼šæ•°æ®ä¸å®Œæ•´

```powershell
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
type data\cache\pe_errors_*.txt

# å¼ºåˆ¶é‡æ–°è®¡ç®—
.venv\Scripts\python.exe scripts/batch_compute_pe_v2.py --force-update
```

## ä¸å…¶ä»–è„šæœ¬é›†æˆ

### classify_stocks_by_pe.py é›†æˆç¤ºä¾‹

å¯ä»¥ä¿®æ”¹ `classify_stocks_by_pe.py` ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼š

```python
from app.data.pe_cache import PECache

# åŠ è½½ç¼“å­˜
cache = PECache()
cache_data = cache.load_cache()

# ä½¿ç”¨ç¼“å­˜æ•°æ®è¿›è¡Œåˆ†ç±»
for ts_code, pe_data in cache_data.items():
    # åˆ†ç±»é€»è¾‘...
    pass
```

## æŠ€æœ¯æ¶æ„

```
ç”¨æˆ·ç•Œé¢å±‚
â”œâ”€â”€ Streamlit Webç•Œé¢ (pages/7_PE_Cache_Manager.py)
â””â”€â”€ å‘½ä»¤è¡Œè„šæœ¬ (scripts/batch_compute_pe_v2.py)

ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ æ‰¹é‡è®¡ç®— (batch_compute_and_cache)
â”œâ”€â”€ è¿›åº¦å›è°ƒ
â””â”€â”€ é”™è¯¯å¤„ç†

æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ ç¼“å­˜ç®¡ç† (PECache)
â”œâ”€â”€ PEè®¡ç®— (calculate_all_pe_ratios)
â””â”€â”€ Tushareæ¥å£ (æ‰¹é‡ä¼˜åŒ–)

å­˜å‚¨å±‚
â”œâ”€â”€ JSONç¼“å­˜ (data/cache/pe_cache.json)
â”œâ”€â”€ å…ƒæ•°æ® (data/cache/pe_cache_metadata.json)
â””â”€â”€ CSVå¯¼å‡º (data/pe_ratios_*.csv)
```

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **Redisç¼“å­˜ï¼š** æ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¤šè¿›ç¨‹å…±äº«
2. **SQLiteå­˜å‚¨ï¼š** æ”¯æŒSQLæŸ¥è¯¢å’Œç´¢å¼•
3. **å¼‚æ­¥å¹¶å‘ï¼š** ä½¿ç”¨asyncioæå‡è®¡ç®—æ•ˆç‡
4. **å¢é‡å­—æ®µæ›´æ–°ï¼š** ä»…æ›´æ–°å˜åŒ–çš„å­—æ®µè€Œéæ•´æ¡è®°å½•
5. **ç¼“å­˜é¢„çƒ­ï¼š** å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ›´æ–°ç¼“å­˜
