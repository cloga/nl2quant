# DCA 定投回测平台 (DCA Backtest Platform)

## 概述

这是一个完整的 **定投(DCA: Dollar Cost Averaging)回测系统**，专为中国 A 股 ETF 投资者设计。支持自定义组合配置、灵活的投资频率，以及详细的性能分析。

## 功能特性

### 核心功能
- ✅ **多资产定投回测** - 支持单资产或组合投资
- ✅ **灵活的投资频率** - 月度、季度、年度投资计划
- ✅ **预设组合** - 内置全天候、60/40、指数等典型组合
- ✅ **自定义配置** - 支持任意 ETF 代码和权重组合
- ✅ **完整的性能指标** - CAGR、Sharpe、最大回撤等关键指标
- ✅ **持仓分析** - 期末持仓明细、成本价、浮盈等
- ✅ **交易记录** - 完整的交易历史追踪
- ✅ **数据导出** - 下载净值曲线、持仓、交易记录等

### 性能指标
应用程序生成以下关键指标：

| 指标 | 说明 | 用途 |
|------|------|------|
| **总投资额** | 累计投入的总金额 | 基准对比 |
| **期末资产** | 回测结束时的总资产 | 评估绝对收益 |
| **总收益率** | (期末 - 投入) / 投入 | 回测期间的总体表现 |
| **CAGR** | 年化复合增长率 | 衡量长期增长能力 |
| **Sharpe 比率** | 风险调整后收益 / 波动率 | 评估风险效率 |
| **波动率** | 收益率的标准差 | 衡量风险水平 |
| **最大回撤** | 历史最大下跌幅度 | 评估抗风险能力 |

## 文件结构

```
nl2quant/
├── app/
│   └── dca_backtest_engine.py     # 后端回测引擎
├── dca_web_app.py                 # Streamlit Web 应用
└── README_DCA.md                  # 本文档
```

## 安装与使用

### 1. 环境准备

确保已安装所有依赖：

```bash
pip install -r requirements.txt
```

关键依赖：
- `streamlit >= 1.0` - Web 框架
- `tushare >= 1.2` - 数据源
- `plotly >= 5.0` - 图表库
- `pandas >= 1.3` - 数据处理

### 2. 配置 Tushare Token

应用需要 Tushare API token。有两种方式配置：

**方式 A: 环境变量**
```bash
# 在 .env 文件中添加
TUSHARE_TOKEN=your_token_here
```

**方式 B: 应用程序启动参数**
应用会自动读取 `config.py` 中的 `TUSHARE_TOKEN`

### 3. 启动应用

```bash
streamlit run dca_web_app.py
```

应用会在 `http://localhost:8501` 上启动。

## 使用指南

### 快速开始

1. **选择组合** (左侧边栏)
   - "全天候组合"：适合风险厌恶型投资者
   - "债券+股票"：60% 债券 + 40% 股票
   - "指数组合"：多地区指数平衡
   - "自定义"：自己配置

2. **设置投资参数**
   - 每次投资金额：1000 - 100000 元
   - 投资频率：月度/季度/年度
   - 时间范围：选择开始和结束日期

3. **运行回测**
   - 点击"开始回测"按钮
   - 等待数据加载完成

4. **分析结果**
   - 查看核心指标
   - 观察净值曲线
   - 分析期末持仓
   - 导出数据进行深度分析

### 常用 ETF 代码参考

#### 债券类
| 代码 | 名称 | 说明 |
|------|------|------|
| 511260 | 十年国债 ETF | 长期国债，低风险 |
| 511380 | 五年国债 ETF | 中期国债 |

#### 国内股票指数
| 代码 | 名称 | 说明 |
|------|------|------|
| 510300 | 沪深300 ETF | A股核心蓝筹 |
| 510500 | 中证500 ETF | A股中小盘 |
| 159920 | 恒生 ETF | 香港主板蓝筹 |
| 515080 | 中证红利 ETF | 高分红优质股 |

#### 海外指数
| 代码 | 名称 | 说明 |
|------|------|------|
| 513100 | 纳斯达克100 | 美国科技龙头 |
| 513400 | 日经225 | 日本主板指数 |

#### 商品与大宗
| 代码 | 名称 | 说明 |
|------|------|------|
| 518880 | 黄金 ETF | 避险资产 |
| 501018 | 南方原油 | 能源配置 |
| 159980 | 有色 ETF | 工业金属 |
| 159985 | 豆粕 ETF | 农产品 |

## 核心模块说明

### DCABacktestEngine (dca_backtest_engine.py)

后端回测引擎，核心类和方法：

```python
class DCABacktestEngine:
    def __init__(self, tushare_token: str):
        """初始化引擎"""
        
    def run_dca_backtest(
        codes: List[str],           # ETF 代码列表
        weights: Dict[str, float],  # 权重分配
        monthly_investment: float,  # 每期投资金额
        start_date: str,            # 开始日期 (YYYYMMDD)
        end_date: str,              # 结束日期 (YYYYMMDD)
        rebalance_freq: str         # 投资频率 (M/Q/Y)
    ) -> Dict:
        """
        运行定投回测
        
        返回值包含：
        - equity_curve: pd.Series, 日净值曲线
        - metrics: Dict, 性能指标
        - positions: Dict, 期末持仓
        - transactions: pd.DataFrame, 交易记录
        """
```

### Streamlit 应用 (dca_web_app.py)

Web 前端应用，主要功能：

1. **左侧配置面板**
   - 预设组合选择
   - 自定义权重调整
   - 投资参数设置
   - 时间范围选择

2. **主内容区域**
   - 组合配置显示
   - 核心指标展示
   - 净值曲线图表
   - 持仓明细表格
   - 交易历史记录
   - 数据导出功能

## API 说明

### 数据获取

应用使用 Tushare 的 `fund_daily` API 获取 ETF 数据：

```python
# 内部实现了分段获取和重试机制
engine.fetch_etf_close(
    code="511260",
    start_date="20200101",
    end_date="20251209"
) -> pd.Series  # 返回日期索引的收盘价 Series
```

### 性能指标计算

```python
# CAGR 计算
cagr = (final_value / total_invested) ** (1 / years) - 1

# Sharpe 比率 (无风险利率为0)
sharpe = annual_return / annual_volatility

# 最大回撤
max_drawdown = min((value - cummax) / cummax for all dates)
```

## 常见问题 (FAQ)

### Q1: 如何获取 Tushare Token？
前往 [Tushare 官网](https://www.tushare.pro/) 注册账户，在"个人中心"获取 token。

### Q2: 为什么某些 ETF 没有数据？
- ETF 可能未成立或已下市
- 指定的时间范围内没有数据
- ETF 代码格式不正确（应为 6 位）

### Q3: 如何理解 Sharpe 比率？
- Sharpe > 1.0：良好的风险调整收益
- Sharpe > 2.0：优秀的风险调整收益
- 全天候组合 Sharpe 通常在 0.8-1.2 之间

### Q4: 最大回撤如何解读？
最大回撤越小，抗风险能力越强。例如：
- -5%：波动较小，较为稳健
- -15%：中等风险
- -30%+：高风险，需谨慎

### Q5: 如何导出数据进行深度分析？
应用提供三种导出功能：
1. **净值曲线** - CSV 格式，用于图表分析
2. **持仓信息** - 期末所有头寸详情
3. **交易记录** - 完整的交易历史

## 性能优化建议

对于大规模回测或多资产组合：

1. **减少数据量**
   - 使用更短的时间范围
   - 选择关键时期进行测试

2. **优化投资频率**
   - 月度投资：更频繁，更多交易
   - 季度/年度：交易较少，计算速度快

3. **网络优化**
   - 在网络良好的环境运行
   - 考虑离线缓存历史数据

## 开发与扩展

### 添加新的预设组合

在 `dca_web_app.py` 的 `predefined_portfolios` 中添加：

```python
"新组合名称": {
    "codes": ["511260", "510300", "159920"],
    "weights": {
        "511260": 0.50,
        "510300": 0.30,
        "159920": 0.20,
    },
},
```

### 自定义性能指标

在 `DCABacktestEngine._compute_metrics()` 中添加新指标：

```python
# 例如：添加年化下行波动率
downside_returns = returns[returns < 0]
downside_volatility = downside_returns.std() * np.sqrt(252)
```

## 限制与注意事项

1. **数据质量**
   - 基于 Tushare 提供的历史数据
   - 不包含股权分配、基金分红等特殊事件调整

2. **成本假设**
   - 不考虑佣金和交易费用
   - 不考虑滑点
   - 不考虑税费

3. **风险提示**
   - 历史性能不代表未来结果
   - 回测结果仅供参考，不构成投资建议
   - 实际投资需考虑个人风险承受能力

## 更新日志

### v1.0 (2025-12-09)
- ✅ 完整的定投回测功能
- ✅ 多种预设组合
- ✅ Web 交互界面
- ✅ 数据导出功能

## 许可证

本项目为内部使用，遵循项目许可证。

## 贡献

欢迎提交改进建议和反馈！

---

**最后更新**: 2025-12-09  
**版本**: 1.0
